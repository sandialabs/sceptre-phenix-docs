# Configuration Files

`phenix` currently supports six (6) different configuration file types:

* [Topology](#topology)
* [Scenario](#scenario)
* [Experiment](#experiment)
* [Image](#image)
* [User](#user)
* [Role](#role)

Typically, users will create `Topology` and `Scenario` configuration files by
hand, while the rest will be generated by `phenix` using available commands.
However, it is possible to create all configuration file types by hand if
necessary.

Configuration files are versioned using a header section based heavily on what
[Kubernetes](https://kubernetes.io) does. Each configuration file will have a
header section that looks like the following:

```
apiVersion: phenix.sandia.gov/v1
kind: Topology
metadata:
  name: foobar
spec:
  ...
```

In the example above, the `kind` field represents the type of configuration file
(e.g., Topology, Scenario, Image). The `apiVersion` field represents the
version the `spec` section conforms to (currently there is only `v1` for all
configuration types), and the `spec` section will contain the actual details for
the configuration type based on the configuration schema. Note that, at least in
the header section, keys are camel-case and begin with a lowercase letter, while
values are camel-cased but begin with a capital letter.

!!! note
    Throughout the documentation, we mention `creating configurations manually`.
    When we say this, we mean passing a YAML or JSON configuration file of any
    type to the `phenix config create` command.

## Topology

The `Topology` configuration is one of the core configuration types for
`phenix`, as it describes a network topology to be deployed in `minimega` that
can be used by one or more experiments to be executed.

A topology is comprised of one or more _nodes_ (which is a VM or container), each
including system descriptions and configurations, as well as any networking
settings required to connect all of the nodes in a topology together. This
configuration becomes the basis for most of the minimega commands later created
in the relevant minimega startup script.

### Default Settings

If left unmodified or unset, the following are the default settings for each
node:
- memory will be set to 512MB
- snapshot will be set to true
- no network settings will be included

### Required Values

Each topology must have a unique name, which should be lowercase and not include
spaces. In addition, each node in the topology must:

- have a specified type (available types are defined in the
  [schema](schema.md#node-schema)
- have a unique hostname
- have an OS type of `linux` or `windows`
- have a disk image assigned

### Optional Values

Optional values for a node in the topology configuration can include:

- static network configurations
- specific memory values (e.g., 1-16GB)
- specific VCPUs values (e.g., 1-4)
- additional disk storage
- file injections
- labels (typically used by phenix apps)
- routing ruleset(s)

### Example

A contrived, four node example -- three VMs and a router -- is given below, and is
driven by the [topology schema described here](schema.md#topology-schema).

```
apiVersion: phenix.sandia.gov/v1
kind: Topology
metadata:
  name: foobar
spec:
  nodes:
  - type: VirtualMachine
    general:
      hostname: host-00
      snapshot: true
    hardware:
      os_type: linux
      drives:
      - image: ubuntu.qc2
    injections:
      - src: foo/bar/sucka.fish
        dst: /data/sucka.fish
      - src: /foo/bar/sucka/fish.sh
        dst: /data/fish.sh
    network:
      interfaces:
      - name: IF0
        vlan: EXP-1
        address: 192.168.10.1
        mask: 24
        gateway: 192.168.10.254
        proto: static
        type: ethernet
      - name: IF1
        vlan: MGMT
        address: 172.16.10.1
        mask: 16
        proto: static
        type: ethernet
  - type: VirtualMachine
    general:
      hostname: host-01
      snapshot: true
    hardware:
      os_type: linux
      drives:
      - image: ubuntu.qc2
    network:
      interfaces:
      - name: IF0
        vlan: EXP-1
        address: 192.168.10.2
        mask: 24
        gateway: 192.168.10.254
        proto: static
        type: ethernet
      - name: IF1
        vlan: MGMT
        address: 172.16.10.2
        mask: 16
        proto: static
        type: ethernet
      - name: S0
        vlan: EXT
        address: 10.0.0.1
        mask: 24
        proto: static
        type: serial
        udp_port: 8989
        baud_rate: 9600
        device: /dev/ttyS0
  - type: VirtualMachine
    general:
      hostname: AD1
      snapshot: true
    hardware:
      os_type: windows
      drives:
      - image: win-svr-2k8.qc2
    network:
      interfaces:
      - name: IF0
        vlan: EXP-1
        address: 192.168.10.250
        mask: 24
        gateway: 192.168.10.254
        proto: static
        type: ethernet
      - name: IF1
        vlan: MGMT
        address: 172.16.10.3
        mask: 16
        proto: static
        type: ethernet
  - type: Router
    labels:
      ntp-server: "true"
    general:
      hostname: router-00
      snapshot: true
    hardware:
      os_type: linux
      drives:
      - image: vyatta.qc2
    network:
      interfaces:
      - name: IF0
        vlan: EXP-1
        address: 192.168.10.254
        mask: 24
        proto: static
        type: ethernet
        ruleset_in: test
      - name: IF1
        vlan: MGMT
        address: 172.16.10.254
        mask: 16
        proto: static
        type: ethernet
      rulesets:
      - name: test
        default: drop
        rules:
        - id: 10
          action: accept
          protocol: all
          source:
            address: 1.1.1.1
            port: 53
```

## Scenario

The `Scenario` configuration is used to define and configure one or more
`phenix` apps ([default](apps.md#default-apps) or 
[user](apps.md#user-apps)) for use on a topology. In this sense, a
topology can have one or more scenarios associated with it, but a scenario can
only be associated with a single topology.

There are two categories of `phenix` apps that can be configured in a scenario: 1) experiment, 
and 2) host. A scenario can contain zero or more experiment and/or host apps.

### Experiment Apps

An experiment app is a `phenix` app that can be applied to experiment topology
using a single configuration. For example, a `phenix` app that adds a minimega
tap to all hosts in the cluster or one that injects the same file into every
node in the experiment topology would be good candidates for an experiment app.

### Host Apps

A host app is a `phenix` app that 1) does not get applied to all nodes in the
experiment topology, and/or 2) requires a unique configuration for each node.
For example, a `phenix` app that configures a VPN between two nodes in an
experiment using WireGuard would need to be a host app because 1) only two nodes
will be modified, and 2) each of the two nodes will require different
configurations (e.g., one will be a WireGuard client and the other a WireGuard
server). Each configured host app will contain a list of topology nodes to apply
the app to, along with custom metadata for the app specific to the topology
node.

### Example

The following is an example of a configuration for a scenario named `foobar`,
which can only be applied to an accompanying topology named `foobar` (while these
names are the same in this example, the topology and scenario names do not have 
to match). Included in this scenario is an experiment app named `miniccc-injector` 
and three host apps: `startup`, `protonuke` and `wireguard`. Each entry in the list 
of app hosts includes custom app metadata and the hostname of the topology node to 
apply the metadata to.

```
apiVersion: phenix.sandia.gov/v1
kind: Scenario
metadata:
  name: foobar
  annotations:
    topology: foobar
spec:
  apps:
    experiment:
    - name: miniccc-injector 
      metadata:
        # files to inject into each node in experiment, based on OS type
        linux:
          src: /phenix/injects/miniccc
          dst: /usr/local/bin/miniccc
        windows:
          src: /phenix/injects/miniccc.exe
          dst: phenix/miniccc.exe
    host:
    - name: startup
      hosts:
      - hostname: host-00 # hostname of topology node to apply it to
        metadata:
          domain_controller:
            domain: example.com
            ip: 10.0.0.1
            username: admin
            password: SuperSecretPassword
    - name: protonuke
      hosts:
      - hostname: host-01 # hostname of topology node to apply it to
        metadata:
          # protonuke app metadata for this topology node
          args: -logfile /var/log/protonuke.log -level debug -http -https -smtp -ssh 192.168.100.100
    - name: wireguard
      hosts:
      - hostname: AD1 # hostname of topology node to apply it to
        metadata:
          # wireguard app metadata for this topology node
          infrastructure:
            private_key: GLlxWJom8cQViGHojqOUShWIZG7IsSX8
            address: 10.255.255.1/24
            listen_port: 51820
          peers:
            public_key: +joyya2F9g72qbKBtPDn00mIevG1j1OqeN76ylFLsiE=
            allowed_ips: 10.255.255.10/32
```

!!! note
    The above example includes a host app named `startup`, which is a phenix
    _default_ app. Meaning, it is possible to configure default phenix apps in a
    scenario configuration, not just user apps.

## Experiment

`Experiment` configurations represent the combination of topologies and scenarios
to form an experiment (though experiments do not require a scenario).

Typically experiment configurations are [created
automatically](experiments.md#create-a-new-experiment), but it is possible to
create them manually using a configuration file similar to the one shown below.
In this case, an experiment named `foobar` would be created based on an existing
topology named `foobar` and an existing scenario named `foobar` (note that none
of the names have to match).

```
apiVersion: phenix.sandia.gov/v1
kind: Experiment
metadata:
  name: foobar
  annotations:
    topology: foobar # this is required
    scenario: foobar # this is optional
```

Once created, either manually or automatically, the experiment configuration
will be expanded to have the topology and scenario configurations embedded in
it, as well as additional details like cluster host schedules for VMs, VLAN
ranges, etc. The advantage of embedding the topology and scenario into the
experiment is that they can be modified in the experiment without modifying the
originals.

## Image

The `Image` configuration is used to generate VM disk images using a custom
version of [vmdb2](https://github.com/glattercj/vmdb2). Representing a disk
image in a configuration like this allows for the same disk image to easily be
built in different clusters without having to actually move large disk image
files.

Typically image configurations are [created
automatically](image.md#creating-a-disk-image), but users can also create them
manually using a configuration file similar to the one shown below.

```
apiVersion: phenix.sandia.gov/v1
kind: Image
metadata:
  name: foobar
spec:
  format: qcow2
  mirror: http://us.archive.ubuntu.com/ubuntu/
  packages:
  - initramfs-tools
  - net-tools
  - isc-dhcp-client
  - openssh-server
  - init
  - iputils-ping
  - vim
  - less
  - netbase
  - curl
  - ifupdown
  - dbus
  - linux-image-generic
  - linux-headers-generic
  release: bionic
  size: 5G
  variant: minbase
  scripts:
    POSTBUILD_APT_CLEANUP: |
      apt clean || apt-get clean || echo "unable to clean apt cache"
    POSTBUILD_NO_ROOT_PASSWD: |
      sed -i 's/nullok_secure/nullok/' /etc/pam.d/common-auth
      sed -i 's/#PermitRootLogin prohibit-password/PermitRootLogin yes/' /etc/ssh/sshd_config
      sed -i 's/#PermitEmptyPasswords no/PermitEmptyPasswords yes/' /etc/ssh/sshd_config
      sed -i 's/PermitRootLogin prohibit-password/PermitRootLogin yes/' /etc/ssh/sshd_config
      sed -i 's/PermitEmptyPasswords no/PermitEmptyPasswords yes/' /etc/ssh/sshd_config
      passwd -d root
```

## User

The `User` configuration tracks phenix UI user settings (e.g., username,
password, and RBAC permissions). Typically user configurations are created
automatically when a UI admin creates a new user via the UI, but they can also
be created manually using a configuration file similar to the one shown below.

```
apiVersion: phenix.sandia.gov/v1
kind: User
metadata:
  name: admin@foo.com
spec:
  username: admin@foo.com
  first_name: Admin
  last_name: Istrator
  password: ****************
  rbac:
    roleName: Global Admin
    policies:
    - resourceNames:
      - '*'
      resources:
      - '*'
      - '*/*'
      verbs:
      - '*'
    - resourceNames:
      - admin@foo.com
      resources:
      - users
      verbs:
      - get
```

## Role

The `Role` configuration is used to represent a named set of RBAC permissions
that represent a user's role in the UI. When a new user is created, the role
that user should have is specified, and using that role name the appropriate
RBAC permissions are copied from the role configuration into the user
configuration.

There are six (6) default role configurations that get created automatically,
and are described [here](user-administration.md#roles). An example role
configuration is shown below for completeness.

```
apiVersion: phenix.sandia.gov/v1
kind: Role
metadata:
  name: global-admin
spec:
  roleName: Global Admin
  policies:
  - resourceNames:
    - '*'
    resources:
    - '*'
    - '*/*'
    verbs:
    - '*'
```
